- trigger:
  - platform: event
    event_type: set_variable
  - platform: event
    event_type: remove_variable
  - platform: event
    event_type: clear_variables
  action:
  - if: "{{ this.attributes.get('log_events', true) }}"
    then:
    - service: logbook.log
      data:
        name: "{{ trigger.event.event_type }}:"
        message: >
          {{ trigger.event.data.key | default('-') }}
          {%- if trigger.event.event_type == 'set_variable' -%}
            : {{ trigger.event.data.value | default('not defined!')}}.
          {%- endif -%}
  sensor:
  - unique_id: c387e0bd-61dc-4203-95b6-1b7d317ecbbb
    name: Variables
    state: Variables
    attributes:
      default_timestamp: false
      log_events: true
      variables: >
        {% set current = this.attributes.get('variables', {}) %}
        {% if trigger.event.event_type == 'set_variable'
          and trigger.event.data.key is defined
          and trigger.event.data.value is defined
        %}
          {% if trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% set value  = trigger.event.data.value %}
            {% set value = value.isoformat() if value is datetime else value %}
            {% set new = {trigger.event.data.key: {'value': value, 'timestamp': now().isoformat()}} %}
          {% else %}
            {% set new = {trigger.event.data.key: trigger.event.data.value} %}
          {% endif %}
          {{ dict(current, **new) }}
        {% elif trigger.event.event_type == 'remove_variable'
          and trigger.event.data.key is defined
        %}
          {{ dict(current.items() | rejectattr('0', 'eq', trigger.event.data.key)) }}
        {% elif trigger.event.event_type == 'clear_variables' %}
          {{ {} }}
        {% else %}
          {{ current }}
        {% endif %}
